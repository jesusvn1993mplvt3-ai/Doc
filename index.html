<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mando MAES26</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; user-select: none; }
        .btn-press:active { transform: scale(0.90); filter: brightness(1.2); }
        .d-pad-btn { 
            background: #334155; 
            border-bottom: 4px solid #1e293b;
            color: #94a3b8;
            transition: all 0.1s;
        }
        .d-pad-btn:active {
            border-bottom-width: 0px;
            margin-top: 4px;
            background: #475569;
            color: white;
        }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen pb-20"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const MACHINES = [
            { id: 'm35', name: '35' }, { id: 'm39', name: '39' }, { id: 'm40', name: '40' },
            { id: 'm36', name: '36' }, { id: 'm38', name: '38' }, { id: 'm37', name: '37' },
            { id: 'm29', name: '29' }, { id: 'm28', name: '28' }, { id: 'm27', name: '27' },
            { id: 'm33', name: '33' }, { id: 'm1',  name: '01' }, { id: 'm30', name: '30' },
            { id: 'm31', name: '31' }, { id: 'm6',  name: '06' }, { id: 'm32', name: '32' },
            { id: 'm13', name: '13' }, { id: 'm12', name: '12' }, { id: 'm24', name: '24' },
            { id: 'm8',  name: '08' },
        ];

        const RemoteControl = () => {
            const [visibility, setVisibility] = useState({ machines: [] });
            const [navState, setNavState] = useState({ weekOffset: 0, scrollLevel: 0 });
            const [connected, setConnected] = useState(false);

            useEffect(() => {
                signInAnonymously(auth).then(() => setConnected(true));
                const unsubVis = onSnapshot(doc(db, 'settings', 'visibility'), (s) => {
                    if(s.exists()) setVisibility(s.data());
                });
                const unsubNav = onSnapshot(doc(db, 'settings', 'navigation'), (s) => {
                    if(s.exists()) setNavState(s.data());
                    else setDoc(doc(db, 'settings', 'navigation'), { weekOffset: 0, scrollLevel: 0 });
                });
                return () => { unsubVis(); unsubNav(); };
            }, []);

            // --- NAVEGACIÓN DIRECCIONAL CORREGIDA ---
            const updateNav = (type, delta) => {
                const newState = { ...navState };
                
                if (type === 'week') {
                    // Arriba/Abajo (Páginas)
                    newState.weekOffset = (newState.weekOffset || 0) + delta;
                    newState.scrollLevel = 0; // Reset scroll al cambiar de página
                } else if (type === 'scroll') {
                    // Izquierda/Derecha (Scroll Vertical)
                    const newScroll = (newState.scrollLevel || 0) + delta;
                    // Limite a 10 pasos de scroll (ajustable)
                    newState.scrollLevel = Math.max(0, Math.min(newScroll, 10)); 
                } else if (type === 'reset') {
                    newState.weekOffset = 0;
                    newState.scrollLevel = 0;
                }

                setDoc(doc(db, 'settings', 'navigation'), newState, { merge: true });
            };

            // --- VISIBILIDAD ---
            const toggleMachine = async (id) => {
                const isHidden = visibility.machines?.includes(id);
                let newMachines = [...(visibility.machines || [])];
                isHidden ? newMachines = newMachines.filter(m => m !== id) : newMachines.push(id);
                await updateDoc(doc(db, 'settings', 'visibility'), { machines: newMachines });
            };

            return (
                <div className="flex flex-col h-screen bg-slate-900">
                    <div className="bg-slate-800 p-4 flex justify-between items-center shadow-lg z-10">
                        <h1 className="text-lg font-bold text-slate-100 flex items-center gap-2">
                            <i data-lucide="gamepad-2" className="text-blue-500"></i> CONTROL REMOTO
                        </h1>
                        <div className={`w-3 h-3 rounded-full ${connected ? 'bg-green-500 shadow-[0_0_10px_#22c55e]' : 'bg-red-500'}`}></div>
                    </div>

                    {/* ZONA DE NAVEGACIÓN (D-PAD) */}
                    <div className="flex-1 flex flex-col justify-center items-center p-4 bg-slate-900 relative overflow-hidden">
                        <div className="absolute inset-0 opacity-5 pointer-events-none" style={{backgroundImage: 'radial-gradient(circle, #64748b 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>

                        <div className="grid grid-cols-3 grid-rows-3 gap-2 w-full max-w-[280px] aspect-square">
                            
                            {/* UP/DOWN -> WEEKS (PAGES) */}
                            <div className="col-start-2">
                                <button onClick={() => updateNav('week', 1)} className="d-pad-btn w-full h-full rounded-t-2xl flex items-center justify-center">
                                    <i data-lucide="chevrons-up" className="w-10 h-10"></i>
                                </button>
                            </div>

                            {/* LEFT/RIGHT -> SCROLL */}
                            <div className="col-start-1 row-start-2">
                                <button onClick={() => updateNav('scroll', -1)} className="d-pad-btn w-full h-full rounded-l-2xl flex items-center justify-center">
                                    <i data-lucide="chevron-left" className="w-10 h-10"></i>
                                </button>
                            </div>
                            
                            <div className="col-start-2 row-start-2">
                                <button onClick={() => updateNav('reset', 0)} className="bg-blue-600 active:bg-blue-500 text-white w-full h-full rounded-full shadow-lg flex flex-col items-center justify-center btn-press border-4 border-slate-800 z-10">
                                    <span className="text-[10px] font-bold">RESET</span>
                                    <span className="font-black">HOY</span>
                                </button>
                            </div>

                            <div className="col-start-3 row-start-2">
                                <button onClick={() => updateNav('scroll', 1)} className="d-pad-btn w-full h-full rounded-r-2xl flex items-center justify-center">
                                    <i data-lucide="chevron-right" className="w-10 h-10"></i>
                                </button>
                            </div>

                            <div className="col-start-2 row-start-3">
                                <button onClick={() => updateNav('week', -1)} className="d-pad-btn w-full h-full rounded-b-2xl flex items-center justify-center">
                                    <i data-lucide="chevrons-down" className="w-10 h-10"></i>
                                </button>
                            </div>
                        </div>

                        <div className="mt-6 flex justify-between w-full max-w-[280px] text-xs font-bold uppercase tracking-widest px-2">
                            <span className="text-blue-400">PAGINA (Semana): {navState.weekOffset}</span>
                            <span className="text-yellow-400">SCROLL: {navState.scrollLevel}</span>
                        </div>
                    </div>

                    {/* ZONA DE MÁQUINAS (Scrollable) */}
                    <div className="bg-slate-800 p-4 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.5)] max-h-[40vh] overflow-auto">
                        <div className="flex justify-between items-center mb-3 px-2">
                            <span className="text-xs font-bold text-slate-400 uppercase">Visibilidad Máquinas</span>
                            <span className="text-green-400 font-black">{MACHINES.length - (visibility.machines?.length || 0)}</span>
                        </div>
                        <div className="grid grid-cols-4 gap-2 pb-4">
                            {MACHINES.map(m => {
                                const isHidden = visibility.machines?.includes(m.id);
                                return (
                                    <button 
                                        key={m.id}
                                        onClick={() => toggleMachine(m.id)}
                                        className={`btn-press p-3 rounded-lg font-bold text-sm border-b-2 transition-all
                                            ${isHidden 
                                                ? 'bg-slate-900 text-slate-600 border-slate-800' 
                                                : 'bg-emerald-600 text-white border-emerald-800'
                                            }`}
                                    >
                                        {m.name}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RemoteControl />);
        lucide.createIcons();
    </script>
</body>
</html>
