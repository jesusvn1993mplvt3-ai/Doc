<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Remoto - Cirineo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #1e293b; color: white; touch-action: manipulation; }
        /* Botones táctiles responsivos */
        .btn-machine { 
            transition: all 0.1s; 
            active: scale(0.95); 
        }
        .btn-active { 
            background-color: #f59e0b; /* Amber 500 */
            color: black;
            border-color: #d97706;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const Icon = ({ name, size=24 }) => <i data-lucide={name} width={size} height={size}></i>;

        const RemoteApp = () => {
            const [orders, setOrders] = useState([]);
            const [currentStatus, setCurrentStatus] = useState({ type: 'IDLE', target: null });

            useEffect(() => {
                // Leer órdenes para saber qué botones mostrar
                const u1 = db.collection('orders').onSnapshot(s => setOrders(s.docs.map(d=>d.data())));
                // Leer estado actual del control
                const u2 = db.collection('system').doc('tv_control').onSnapshot(doc => {
                    if(doc.exists) setCurrentStatus(doc.data());
                });
                setTimeout(()=>lucide.createIcons(), 500);
                return () => { u1(); u2(); };
            }, []);
            
            useEffect(()=>lucide.createIcons(), [orders]);

            // Obtener máquinas activas
            const machines = useMemo(() => {
                const mqs = new Set();
                orders.forEach(o => { 
                    if(o.status !== 'ARCHIVADO' && o.progreso.some(p => !p.finished)) mqs.add(o.maquina); 
                });
                return Array.from(mqs).sort((a,b)=>a-b);
            }, [orders]);

            // --- ACCIONES ---
            const showReport = async (maquina) => {
                // Verificar vibración para feedback táctil
                if(navigator.vibrate) navigator.vibrate(50);
                await db.collection('system').doc('tv_control').set({
                    type: 'SHOW_REPORT',
                    target: maquina,
                    timestamp: Date.now()
                });
            };

            const resetTV = async () => {
                if(navigator.vibrate) navigator.vibrate(50);
                await db.collection('system').doc('tv_control').set({
                    type: 'IDLE',
                    target: null,
                    timestamp: Date.now()
                });
            };

            return (
                <div className="min-h-screen flex flex-col p-4">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-2">
                            <Icon name="gamepad-2" className="text-indigo-400"/>
                            <h1 className="font-black text-xl tracking-tight">REMOTE <span className="text-indigo-400">CONTROL</span></h1>
                        </div>
                        <div className="text-xs font-mono text-slate-400">
                            {currentStatus.type === 'IDLE' ? 'TV: LISTO' : 'TV: OCUPADO'}
                        </div>
                    </div>

                    <div className="bg-slate-800 rounded-2xl p-4 mb-4 shadow-inner">
                        <h2 className="text-xs font-bold text-slate-500 uppercase mb-3">Seleccionar Máquina</h2>
                        {machines.length === 0 ? (
                            <div className="text-center py-8 text-slate-500 font-bold">Sin máquinas activas</div>
                        ) : (
                            <div className="grid grid-cols-3 gap-3">
                                {machines.map(m => (
                                    <button 
                                        key={m} 
                                        onClick={() => showReport(m)}
                                        className={`btn-machine h-20 rounded-xl font-black text-2xl shadow-lg border-b-4 flex flex-col items-center justify-center 
                                            ${currentStatus.target === m && currentStatus.type === 'SHOW_REPORT' 
                                                ? 'btn-active' 
                                                : 'bg-slate-700 border-slate-900 text-slate-300 hover:bg-slate-600 active:border-b-0 active:translate-y-1'
                                            }`}
                                    >
                                        <span>{m}</span>
                                        {currentStatus.target === m && <span className="text-[8px] uppercase tracking-widest font-normal">Viendo</span>}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Botón grande para cerrar */}
                    <button 
                        onClick={resetTV}
                        disabled={currentStatus.type === 'IDLE'}
                        className={`mt-auto w-full py-6 rounded-2xl font-black text-xl uppercase tracking-widest flex items-center justify-center gap-3 transition-all
                            ${currentStatus.type === 'IDLE' 
                                ? 'bg-slate-800 text-slate-600 opacity-50 cursor-not-allowed' 
                                : 'bg-red-600 text-white shadow-[0_0_20px_rgba(220,38,38,0.5)] active:scale-95'
                            }`}
                    >
                        <Icon name="x-circle" size={28}/> Cerrar Reporte TV
                    </button>
                    
                    <div className="text-center mt-4 text-[10px] text-slate-600">
                        v2.0 PWA Link System
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RemoteApp />);
    </script>
</body>
</html>
